<?php
/**
 * ElielWeb ProductConfigurator - Gold Color Selector Template (Hyva)
 *
 * Displays gold color swatches for product variants
 *
 * @var $block \Magento\Framework\View\Element\Template
 * @var \ElielWeb\ProductConfigurator\ViewModel\GoldColorSelector $goldColorViewModel
 * @var \Magento\Catalog\Api\Data\ProductInterface $product
 */

// Get product from block (Magento\Catalog\Block\Product\View has getProduct() method)
$product = $block->getProduct();
$goldColorViewModel = $block->getData('gold_color_view_model');

if (!$product || !$goldColorViewModel) {
    return;
}

$currentGoldColor = $goldColorViewModel->getCurrentGoldColor($product);

// If product has no gold color attribute set, don't show
if (empty($currentGoldColor)) {
    return;
}

$variants = $goldColorViewModel->getGoldVariants($product);

// If no variants found (no gold_variant_group), create a single-item display for current product
if (empty($variants)) {
    $colorData = $goldColorViewModel->getGoldColorData($currentGoldColor);
    if ($colorData) {
        $variants = [[
            'product_id' => $product->getId(),
            'sku' => $product->getSku(),
            'name' => $product->getName(),
            'gold_color' => $currentGoldColor,
            'gold_color_code' => $colorData['code'],
            'hex_code' => $colorData['hex'],
            'label_fr' => $colorData['label_fr'],
            'label_en' => $colorData['label_en'],
            'url' => $product->getProductUrl(),
            'is_current' => true
        ]];
    }
}

// Get stock status
$stockStatus = $goldColorViewModel->getStockStatus($product);
?>

<div class="gold-color-selector product-option-section" x-data="{ selectedColor: '<?= $escaper->escapeJs($currentGoldColor) ?>' }">
    <!-- Stock Status Display -->
    <div class="stock-status <?= $stockStatus['is_in_stock'] ? 'in-stock' : 'out-of-stock' ?>">
        <span class="stock-label"><?= $escaper->escapeHtml($stockStatus['label']) ?></span>
        <?php if ($stockStatus['is_in_stock'] && $stockStatus['qty'] > 0): ?>
            <span class="stock-qty">(<?= (int)$stockStatus['qty'] ?> <?= $escaper->escapeHtml(__('available')) ?>)</span>
        <?php endif; ?>
    </div>

    <div class="gold-color-row">
        <span class="gold-label"><?= $escaper->escapeHtml(__('GOLD COLOR')) ?></span>
        <div class="gold-swatches-inline">
            <?php foreach ($variants as $variant): ?>
                <?php
                $isCurrent = $variant['is_current'];
                $goldColor = $variant['gold_color'];
                $hexCode = $variant['hex_code'];
                $url = $variant['url'];
                $isWhite = ($variant['gold_color_code'] === 'white');
                ?>
                <a href="<?= $escaper->escapeUrl($url) ?>"
                   class="gold-dot-link <?= $isCurrent ? 'active' : '' ?>"
                   title="<?= $escaper->escapeHtmlAttr($variant['label_fr']) ?>"
                   <?= $isCurrent ? 'aria-current="true"' : '' ?>>
                    <span class="gold-dot <?= $isWhite ? 'light-dot' : '' ?>"
                          style="background-color: <?= $escaper->escapeHtmlAttr($hexCode) ?>;"></span>
                </a>
            <?php endforeach; ?>
        </div>
    </div>
</div>

<style>
.gold-color-selector {
    margin: 0;
    padding: 0;
}

/* Stock Status Styling */
.gold-color-selector .stock-status {
    display: none; /* Hidden - can be shown if needed */
}

/* Gold Color Row - inline like RedLine */
.gold-color-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid #e0e0e0;
}

.gold-label {
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #333;
}

.gold-swatches-inline {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.gold-dot-link {
    display: block;
    text-decoration: none;
    transition: transform 0.2s ease;
}

.gold-dot-link:hover {
    transform: scale(1.2);
}

.gold-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: block;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    border: 1px solid transparent;
}

.gold-dot.light-dot {
    border: 1px solid #d0d0d0;
}

.gold-dot-link.active .gold-dot {
    box-shadow: 0 0 0 2px #333;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .gold-dot {
        width: 14px;
        height: 14px;
    }
}

@media (max-width: 480px) {
    .gold-color-row {
        padding: 0.75rem 0;
    }

    .gold-dot {
        width: 12px;
        height: 12px;
    }
}
</style>
